<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Task Tracer</title>
    <link rel="manifest" href="manifest.json">
    <!--    manifest.json中-->
    <!--    background_color: 启动屏背景色：App 打开瞬间那一秒的背景 (建议与 CSS 背景一致，防闪烁)-->
    <!--    theme_color: 独立窗口顶栏色：电脑端App窗口标题栏/安卓任务管理器卡片顶条颜色-->
    <!-- 定义浏览器周边的 UI 颜色（主要是手机浏览器的地址栏和状态栏背景色-->
    <meta name="theme-color" content="#4b6cb7">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="icon" type="image/png" sizes="32x32" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAA7EAAAOxAGVKw4bAAABW0lEQVRYhe2XO46DMBRFr4cA4iNCS5NdsBHWw07YAhJbSEdBQUOXgia0FCgg/kwFgkxG4yEMpphbvQeW77GNjR/BC5mmObx6voWCICDzfJH8pfF3IBPAnuZzCMLKfNQHK+NRhOXogQPMwImmESEEmqahLEu0bYuu676853kePM9DkiTIsgxN0xBF0TYAAOB5HlRVpW2O+/0Oy7J+bEe1BMMwIAxDavMRgEbUM+C6Lq7XK5IkQZZlUBQFjuMAAG63G2zbhiAIOJ/PMAwDRVFsC+D7/iKfL0eapojjmLarhVbvgrqup/jxeKztZj3AfCfkec4WoGma/QHmYg7wfDDtDtD3PVsAjuPYApxO1MfJdgDzUQuCsD+AJElTLMvy/gC6rk+xoij7A1wuFwBA27ZvfQOrr2SiKEIURWRZttoc+MXf8FlVVaGqqrfMgQPcCZkD/Bcmx6gNWUCM1fEnwG53AxCePfgAAAAASUVORK5CYII=">
    <link rel="shortcut icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAFo9M/3AAAApklEQVR4nLRRwQnEIBBMUwpBkQR8+NQKfAgWYTNWYD2KzeydQg4OY4Lmbh6yrMPs7syyvIEQgvoU1OLT+SqaBqX0goExvmFcNm4JBc8IzYjDjeHPZsS6rnCYsO/7+Q7WWpBS9pfUWsO2bX1CUeCc9wmEkHsnp04dyuonAt57iDFCzrlmW+qUEoQQxjYwxlQBIcTcCSWXAsbYnIBzrgoopf5o4tMYXwAAAP//XH15egAAAAZJREFUAwD7tLYKdxhMJAAAAABJRU5ErkJggg==" />
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAA9zQYyAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAH70lEQVR4nO3dS1ITXxvH8V+TKySEcKlQ4gQHVulYWQE7cgMuwW24BmfKSIJV6oQqGDhRM0i4J1xCSN7BW8kfueZ0nqaT099PVSqKafqUfn3qkDQhUIzW1tZ6cZ4f0alWq0Ec533SkxJwcj1V4JGfhIhxU5RxR/aJCRmPiSJs809IyHBlGbbZJyJkjMoi7JE/ASHD2ihhjxQ0MSMqYaMOHTQxI2phog4VNDHjqbhG7Rw0MeOpuUTtFDQxIy7DRj100MSMuA0T9VBBEzPGxWNRPxo0MWPcPBT1g0ETM8bVfVHfGzQxY9zdFfVUHAsBonLnhGY6Y1LcnNJMaHjl1oRmOmPSXJ/STGh45Z8JzXTGpOpPaSY0vDKY0ExnTLpqtRowoeEVgoZXAontBvzBhIZXCBpeIWh4JWD/DJ8woeEVgoZXCBpeIWh4haDhFYKGVwgaXiFoeIWg4RWChlcIGl4haHiFoOEVgoZX0nEvANHLZrMqlUpaWFjQ4uKi5ufn9evXL21vb8e9NHPeBl0oFPTu3TudnJyo2WyqVWrp9PRU5+fng1u73dbFxYU6nY4uLy8Ht6urq8F9r9dTp9NRr9dTt9v9534YQfDfe/mkUilNTU0pCAKl02kFQTD4WCaTUSqV+uc+nU4rk8kol8spm80qm80ql8spn88Pbv3fz8zMqFAoDG7FYlGlUkmlUkm5XO7Wut6/f0/Qk6TVaunNmzdaWVmJeylj6c+fP3EvIRJe76E3NzfjXsLYIugJRNB3Oz8/197eXtzLiIT3QXe73biXMXZ8nc6S50EfHx9rd3c37mWMnd+/f8e9hMh4HbTEtuMuTOgJ9vXr17iXMHYIeoJ9//5dFxcXcS9jrLDlmGDtdls/f/6MexljhQk94dhH/6fb7erv379xLyMyBJ0w9XpdnU4n7mVEJhFBb29v6+joKO5ljAWf98+Sx9dy3LS1taX19fU7/6zRaKhWq6lWq6nRaOjg4ED7+/uDi5r69+12W+12W5eXl7q4uFCv19PV1dXgYqVPnz6pXC47r+3Dhw/6+PHj4MKlqakppVKpwcVI/QuUisWipqenVSgUNDs7q3K5PLhVKhVVKhUtLy8rn8/fey6f989SgoLe3NzU+vq6jo6OtLW1pW/fvmlnZ0e7u7s6OzszOUe9Xg8V9OHh4eA/x3Vh17W0tKTV1VWtrq7q1atXev36tV68eKF0Ok3QvtjY2NDe3p42NjaGvvTT1d7enl6+fOl8nPV2qNFoqNFoaGtra/CxQqGgt2/fqlarmZ5r3CQm6EajoS9fvkR6jnq9Huq4w8ND45Xc1mq19Pnz58jPE7dEfFH4VMJewcYXrHYI2tA4T+ikIGhDjUbD+ZhOp6NWqxXBapKJoA2F2TocHx9HsJLkImhDzWbT+RiCtkXQhsJM6JOTkwhWklwEbSjMtD09PY1gJclF0IbOzs6cL/zhC0JbBG3MdUoTtC2CNua6J7a6jgT/R9DGzs/PnR4f5pkR3I+gjbkGzYS2RdDGXINmD22LoI25Bs3TdrYI2pjrWya02+2IVpJMBG3MdUITtC2CNuYaNG+CY4ugjbm+UsiEtkXQxly/X5EJbYugjd38zu3HMKFtEbQxthzxImhjbDniRdDG2HLEi6CNuf5MF34GjC2CNpZKpZwe7zrR8TCCNuYadFRvS5ZUBG0snXZ7dzW2HLYI2hhBx4ugjbkGzR7aFkEbYw8dL4I2lslknB7PlsMWQRtjQseLoI25Bg1bBG3MdcsBWwRtjAkdL4I25jqhgyCIaCXJRNDGpqen415CohG0sUKh4PT4qSn+CSzxt2nMNWj23LYI2lixWHR6PEHbImhjrntogrZF0IZSqZRyuZzzMbBD0IZc98+S+9V5eBhBGyLo+BG0oTBB81K5LYI2RNDxI2hDYYLOZrMRrCS5CNrQzMyM8zGuz4rgYQRtqFwuOx+Tz+cjWElyEbQhgo4fQRsKEzRbDlsEbYgJHT+CNjQ3N+d8DEHbImhDYYJ2vToPDyNoQ4uLi87H8B0utgja0Pz8vPMxYZ67xv0I2sjc3FyoC43CvLqI+xG0kTDbDUkqlUrGK0k2gjaytLQU6rjZ2VnjlSQbQRsJO6EJ2hZBG6lUKqGOY8thi6CNhA06zKuLuB9BGwkbdCaT4bloQwRtZHl5OfSxCwsLhitJNoI2EnZCS+FeMsfdCNpANpsdacqGfcoPtxG0gWfPno10PEHbIWgDKysrIx0f9jls3Ma7nBh4/vz50I9tNps6ODjQ/v6+Dg8PdXBwoJ2dnQhXlywEbSCbzerHjx+3Qu3fX/8YP2gzWsHa2ho/VwzeYA8NrxA0vELQ8ApBwysEDa8QNLxC0PAKQcMrBA2vEDS8QtDwCkHDKwQNrxA0vELQ8EogSVwTDV8woeEVgoZXCBpeCfq/YB+NSVetVgMmNLxC0PBKcP03bDswqarVaiAxoeGZ4OYHmNKYNP3pLDGh4ZlbE1piSmNyXJ/OEhManrlzQktMaYy/m9NZYkLDM/dOaIkpjfF113SWHglaImqMn/tiloYIWiJqjI+HYpaGDFoiasTvsZglh6AlokZ8holZcgxaImo8vWFjlkIELRE1no5LzFLIoCWiRvRcY5ZGCFoiakQnTMzSiEFLRA17YWOWDILuI2yMapSQ+8yC7iNsuLIIuc886D7CxmMsQ+6LLOg+wsZNUYTcF3nQ1xF3ckUZ8XX/AyGwyUmxQbNBAAAAAElFTkSuQmCC">
    <style>
        /* === 1. 全局变量定义 (Design Tokens) === */
        :root {
            /* 品牌色 & 状态色 */
            --color-primary: #4b6cb7;
            --color-primary-dark: #3a5aa0;
            --color-secondary: #182848;
            --color-success: #4CAF50;
            --color-success-dark: #388E3C;
            --color-warning: #FFC107;
            --color-danger: #F44336;
            --color-danger-light: rgba(244, 67, 54, 0.1);
            --color-info-light: rgba(75, 108, 183, 0.1);
            --color-success-light: rgba(76, 175, 80, 0.1);

            /* 背景色 (Backgrounds) */
            --bg-gradient-start: #f5f7fa;
            --bg-gradient-end: #c3cfe2;
            --bg-surface: #ffffff;       /* 卡片、弹窗背景 */
            --bg-surface-alt: #f9f9f9;   /* 完成任务、空状态背景 */
            --bg-hover: #f0f0f0;         /* 按钮悬停 */
            --bg-active: #e0e0e0;        /* 按钮激活 */
            --bg-overlay: rgba(0, 0, 0, 0.5); /* 弹窗遮罩 */

            /* 文本色 (Typography) */
            --text-main: #333333;        /* 主要文字 */
            --text-secondary: #666666;   /* 次要信息 */
            --text-tertiary: #999999;    /* 辅助信息 */
            --text-inverse: #ffffff;     /* 反白文字 */

            /* 边框与装饰 (Borders & Decor) */
            --border-base: #dddddd;
            --border-light: #eeeeee;
            --shadow-base: rgba(0, 0, 0, 0.1);
            --shadow-float: rgba(0, 0, 0, 0.15);
            --shadow-heavy: rgba(0, 0, 0, 0.2);
        }

        /* === 2. 深色模式变量 (手动切换支持) === */
        html[data-theme="dark"] {
            /* --- 背景：放弃高饱和渐变，使用沉稳的深灰色 --- */
            --bg-gradient-start: #18181b;  /* Zinc 900 */
            --bg-gradient-end: #18181b;    /* 纯色背景更显干净，或者用极微弱的渐变 */

            /* --- 表面：比背景稍亮，形成层级 --- */
            --bg-surface: #27272a;         /* Zinc 800 - 卡片背景 */
            --bg-surface-alt: #1f1f22;     /* 稍暗的区域 */

            /* --- 交互：明显的悬停色 --- */
            --bg-hover: #3f3f46;           /* Zinc 700 */
            --bg-active: #52525b;          /* Zinc 600 */
            --bg-overlay: rgba(0, 0, 0, 0.7); /* 遮罩 */

            /* --- 文字：降低纯白刺眼感，使用“灰白” --- */
            --text-main: #e4e4e7;          /* Zinc 200 (主要文字) */
            --text-secondary: #a1a1aa;     /* Zinc 400 (次要文字) */
            --text-tertiary: #71717a;      /* Zinc 500 (辅助文字) */
            --text-inverse: #ffffff;       /* 反白文字 */

            /* --- 边框：在深色模式下，边框比阴影更重要 --- */
            --border-base: #3f3f46;        /* Zinc 700 - 明显的分割线 */
            --border-light: #52525b;       /* Zinc 600 */

            /* --- 阴影：加深阴影以在深灰底上显形 --- */
            --shadow-base: 0 1px 3px 0 rgba(0, 0, 0, 0.5);
            --shadow-float: 0 10px 15px -3px rgba(0, 0, 0, 0.7);
            --shadow-heavy: 0 20px 25px -5px rgba(0, 0, 0, 0.9);

            /* --- 状态色：去饱和，变柔和 --- */
            /* 主色：从深蓝变成柔和的靛蓝 */
            --color-primary: #818cf8;      /* Indigo 400 */
            --color-primary-dark: #6366f1; /* Indigo 500 */

            /* 状态色：避免荧光色，使用 Pastel (粉彩) 色系 */
            --color-success: #34d399;      /* Emerald 400 (柔和绿) */
            --color-warning: #fbbf24;      /* Amber 400 (柔和黄) */
            --color-danger: #f87171;       /* Red 400 (柔和红) */

            /* 背景色微调：增加透明度，让背景色透出来 */
            --color-danger-light: rgba(248, 113, 113, 0.15);
            --color-info-light: rgba(129, 140, 248, 0.15);
            --color-success-light: rgba(52, 211, 153, 0.15);
        }

        html[data-theme="dark"] img,
        html[data-theme="dark"] svg { opacity: 0.9; }
        html[data-theme="dark"] .container,
        html[data-theme="dark"] .task-item,
        html[data-theme="dark"] .modal-content,
        html[data-theme="dark"] .menu { border: 1px solid rgba(255, 255, 255, 0.08); }

        html[data-theme="dark"] input,
        html[data-theme="dark"] textarea { background-color: #18181b; border-color: var(--border-base); }
        html[data-theme="dark"] input:focus,
        html[data-theme="dark"] textarea:focus { border-color: var(--color-primary); background-color: #18181b; }

        /* === 太阳/月亮 图标切换逻辑 === */
        .sun-icon { display: none; }
        .moon-icon { display: block; }
        html[data-theme="dark"] .sun-icon { display: block; }
        html[data-theme="dark"] .moon-icon { display: none; }

        /* === 基本重置与布局 === */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%); min-height: 100vh; padding: 20px; color: var(--text-main); transition: background 0.3s ease, color 0.3s ease; }
        .container, .task-item, .modal-content, input, textarea, .menu { transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease; }
        .container { max-width: 800px; margin: 0 auto; background: var(--bg-surface); border-radius: 12px; box-shadow: 0 10px 30px var(--shadow-base); overflow: hidden; position: relative; }
        /* === 可访问性 (A11y) 样式 用于隐藏元素，但保持屏幕阅读器可读 ===*/
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }

        /* === Header === */
        header { background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%); color: var(--text-inverse); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; }
        h1 { font-size: 22px; font-weight: 600; }
        html[lang="en"] h1 { font-size: 24px; }
        .subtitle { font-size: 14px; opacity: 0.8; line-height: 1.3; }
        .header-actions { display: flex; gap: 10px; align-items: center; }

        .icon-btn, .lang-btn { background: rgba(255, 255, 255, 0.2); color: var(--text-inverse); border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px; transition: background 0.2s; }
        .icon-btn { background: var(--color-primary); font-weight: 600; }
        /* 手机端点击时的“按压”回弹效果 */
        .icon-btn:active { background: var(--color-primary-dark); transform: scale(0.95); }
        /* === 仅在电脑端启用悬停效果 (解决手机端粘滞问题) === */
        @media (hover: hover) { .icon-btn:hover { background: var(--color-primary-dark); transform: translateY(-2px); box-shadow: 0 4px 8px var(--shadow-base); } }

        /* === Menu === */
        .menu { display: none; position: absolute; top: 55px; right: 15px; background: var(--bg-surface); border-radius: 8px; box-shadow: 0 4px 12px var(--shadow-float); z-index: 500; min-width: 100px; padding: 8px 0; }
        .menu.show { display: block; }
        .menu-item { display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 15px; border: none; background: none; text-align: center; cursor: pointer; font-size: 14px; color: var(--text-main); }
        .menu-item:active { background: var(--bg-active); }
        .menu-item svg { width: 16px; height: 16px; color: var(--color-primary); fill: none; }
        @media (hover: hover) { .menu-item:hover { background: var(--bg-hover); } }
        .menu-divider { height: 1px; background: var(--border-light); margin: 8px 0; }

        .submenu { display: none; background: var(--bg-surface-alt); overflow: hidden; max-height: 0; transition: max-height 0.3s ease-out; }
        .submenu.show { display: block; max-height: 200px; }
        .submenu .lang-btn { padding-left: 41px; color: var(--text-main); background: none; width: 100%; text-align: left; border-radius: 0; font-weight: normal; }
        .submenu .lang-btn:hover { background: var(--bg-hover); }
        .submenu .lang-btn.active { background: var(--bg-active); font-weight: bold; }
        #langMenuToggle.open svg:last-child { transform: rotate(90deg); }

        /* === Main Content & Controls === */
        .main-content { padding: 20px; }
        .controls-bar { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }

        .search-box { position: relative; display: flex; align-items: center; flex: 1; margin-bottom: 0; }
        .search-input { width: 100%; padding: 10px 45px 10px 12px; border: 1px solid var(--border-base); border-radius: 6px; font-size: 14px; background: var(--bg-surface); color: var(--text-main); }

        .dropdown-container { position: relative; }
        .dropdown-btn { background: var(--bg-surface); border: 1px solid var(--border-base); color: var(--text-main); padding: 8px 12px; border-radius: 6px; font-size: 14px; cursor: pointer; display: flex; align-items: center; transition: all 0.2s; height: 42px; white-space: nowrap; gap: 8px; min-width: 140px; }
        .dropdown-btn .chevron { margin-left: auto; opacity: 0.5; }
        .dropdown-btn:hover { background: var(--bg-hover); border-color: var(--color-primary); }
        .dropdown-btn.active { background: var(--bg-active); border-color: var(--color-primary); }
        .dropdown-btn svg { transition: transform 0.2s; }

        .dropdown-menu-content { display: none; position: absolute; top: 100%; right: 0; margin-top: 5px; background: var(--bg-surface); border: 1px solid var(--border-base); border-radius: 8px; box-shadow: 0 4px 12px var(--shadow-float); z-index: 100; min-width: 150px; overflow: hidden; animation: fadeIn 0.2s ease; }
        .dropdown-container.show .dropdown-menu-content { display: block; }
        .dropdown-container.show .dropdown-btn .chevron { transform: rotate(180deg); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .dropdown-option { width: 100%; text-align: left; padding: 10px 15px; background: none; border: none; color: var(--text-main); cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: space-between; }
        .dropdown-option:hover { background: var(--bg-hover); }
        .dropdown-option.selected { color: var(--color-primary); font-weight: 600; background: var(--bg-surface-alt); }
        .dropdown-option svg { opacity: 0; color: var(--color-primary); }
        .dropdown-option.selected svg { opacity: 1; }

        /* === Tasks === */
        .tasks-section { margin-bottom: 25px; }
        .task-item { --task-color: var(--color-primary); background: var(--bg-surface); border-left: 5px solid var(--task-color); border-radius: 8px; padding: 15px; margin-bottom: 12px; box-shadow: 0 3px 10px var(--shadow-base); transition: transform 0.2s; position: relative; overflow: hidden; }
        .task-item:hover { transform: translateY(-2px); box-shadow: 0 5px 15px var(--shadow-base); }
        /* 状态颜色映射 */
        .task-item.status-safe { --task-color: var(--color-success); }
        .task-item.status-warning { --task-color: var(--color-warning); }
        .task-item.status-danger { --task-color: var(--color-danger); }
        .task-item.status-no-deadline { --task-color: var(--text-tertiary); }
        .task-item.completed { --task-color: var(--color-success); background-color: var(--bg-surface-alt); opacity: 0.8; }
        .completed-task .task-name .task-title { text-decoration: line-through; color: var(--text-tertiary); }
        .task-item.animate-complete { animation: completeAnimation 0.5s ease; }
        @keyframes completeAnimation { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .task-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .task-title { font-size: 16px; font-weight: 600; color: var(--text-main); display: flex; align-items: center; gap: 8px; word-break: break-all; }
        .task-date { font-size: 12px; color: var(--text-secondary); background: var(--bg-hover); padding: 3px 8px; border-radius: 15px; white-space: nowrap; }
        .task-desc { color: var(--text-secondary); margin-bottom: 10px; line-height: 1.4; font-size: 14px; word-break: break-word; }

        .progress-bar { height: 5px; background: var(--bg-hover); border-radius: 3px; margin-top: 8px; overflow: hidden; margin-bottom: 10px; }
        .progress-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; background-color: var(--task-color); }

        .task-footer { display: flex; justify-content: space-between; align-items: center; }
        .status-indicator { display: flex; align-items: center; font-size: 13px; font-weight: 500; color: var(--text-main); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 6px; background-color: var(--task-color); }
        .status-time-left { margin-left: 5px; color: var(--text-secondary); }

        /* Actions */
        .task-actions { display: flex; gap: 8px; }
        .action-btn { background: none; border: none; cursor: pointer; font-size: 16px; transition: color 0.2s; padding: 5px; border-radius: 4px; display: flex; align-items: center; justify-content: center; }
        .edit-btn { color: var(--color-primary); }
        .edit-btn:hover { color: var(--color-primary-dark); background: var(--color-info-light); }
        .delete-btn { color: var(--text-tertiary); }
        .delete-btn:hover { color: var(--color-danger); background: var(--color-danger-light); }
        .complete-btn { color: var(--color-success); }
        .complete-btn:hover { color: var(--color-success-dark); background: var(--color-success-light); }

        /* === Subtasks (Child Tasks) === */
        /* Modal Input */
        .subtask-input-wrapper { display: flex; gap: 8px; margin-bottom: 10px; }
        .btn-icon-small { background: var(--bg-hover); border: 1px solid var(--border-base); border-radius: 6px; cursor: pointer; color: var(--text-main); width: 40px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .btn-icon-small:hover { background: var(--color-primary); color: white; border-color: var(--color-primary); }
        .subtask-preview-list { list-style: none; padding: 0; margin: 0; max-height: 150px; overflow-y: auto; }
        .subtask-preview-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: var(--bg-hover); border-radius: 4px; margin-bottom: 5px; font-size: 13px; }
        .subtask-delete-btn { background: none; border: none; color: var(--text-tertiary); cursor: pointer; padding: 2px; }
        .subtask-delete-btn:hover { color: var(--color-danger); }

        /* Card Display */
        .subtask-summary-bar { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-top: 1px solid var(--border-light); margin-top: 10px; cursor: pointer; color: var(--text-secondary); font-size: 13px; user-select: none; }
        .subtask-summary-bar:hover { color: var(--color-primary); }
        .subtask-count-text { font-weight: 500; display: flex; align-items: center; gap: 6px; }
        .subtask-toggle-icon { transition: transform 0.3s ease; opacity: 0.6; }

        .subtasks-list { display: none; padding-top: 5px; padding-bottom: 5px; border-top: 1px dashed var(--border-light); animation: slideDown 0.2s ease-out; }
        .subtasks-wrapper.expanded .subtasks-list { display: block; }
        .subtasks-wrapper.expanded .subtask-toggle-icon { transform: rotate(180deg); }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .subtask-display-item { display: flex; align-items: center; gap: 8px; padding: 6px 0; font-size: 13px; color: var(--text-main); cursor: pointer; transition: background-color 0.2s; }
        .subtask-text { line-height: 1.4; word-break: break-all; }
        .subtask-display-item.completed .subtask-text { text-decoration: line-through; color: var(--text-tertiary); }

        /* Subtask Checkbox (Green Square with SVG Check) */
        .subtask-checkbox { padding: 0; appearance: none; -webkit-appearance: none; width: 18px; height: 18px; border-radius: 4px; cursor: pointer; position: relative; transition: all 0.2s ease; margin-right: 8px; background-color: var(--bg-surface); }
        .subtask-checkbox:hover { border-color: var(--color-success); background-color: var(--bg-hover); }
        .subtask-checkbox:checked { border-color: var(--color-success); background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M5 13l4 4L19 7'/%3E%3C/svg%3E"); background-size: 80%; background-position: center; background-repeat: no-repeat; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* === Modal & Forms === */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-overlay); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: var(--bg-surface); border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px var(--shadow-heavy); animation: modalAppear 0.3s ease; }
        @keyframes modalAppear { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-header { background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%); color: var(--text-inverse); padding: 15px 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 18px; font-weight: 600; }
        .close-btn { background: none; border: none; color: var(--text-inverse); font-size: 20px; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.2s; }
        .close-btn:hover { background: rgba(255, 255, 255, 0.2); }
        .modal-body { padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-main); }
        input, textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border-base); border-radius: 6px; font-size: 14px; transition: border 0.3s; background: var(--bg-surface); color: var(--text-main); }
        input:focus, textarea:focus { border-color: var(--color-primary); outline: none; box-shadow: 0 0 0 2px var(--color-info-light); }
        textarea { min-height: 70px; resize: vertical; }
        .datetime-group { display: flex; gap: 10px; align-items: center; }
        .date-input, .time-input { flex: 1; }
        .checkbox-group { display: flex; align-items: center; gap: 8px; margin-top: 10px; }
        .checkbox-group input[type="checkbox"] { width: auto; }
        .form-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn { padding: 10px 20px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; }
        .btn-primary { background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%); color: var(--text-inverse); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px var(--shadow-base); }
        .btn-secondary { background: var(--bg-hover); color: var(--text-main); }
        .btn-secondary:hover { background: var(--bg-active); }

        /* === States & Misc === */
        .loading-state { text-align: center; padding: 40px 20px; color: var(--text-tertiary); }
        .loading-state .spinner { width: 40px; height: 40px; border: 4px solid var(--bg-hover); border-top-color: var(--color-primary); border-radius: 50%; margin: 0 auto 15px auto; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 30px 20px; color: var(--text-tertiary); background: var(--bg-surface-alt); border-radius: 8px; border: 2px dashed var(--border-base); }
        .empty-state svg { margin-bottom: 15px; opacity: 0.6; }
        .empty-state h3 { font-size: 16px; margin-bottom: 8px; color: var(--text-secondary); }
        .empty-state p { font-size: 14px; }
        .file-input { display: none; }
        .notification { position: fixed; top: 20px; right: 20px; background: var(--color-success); color: var(--text-inverse); padding: 12px 20px; border-radius: 6px; box-shadow: 0 4px 12px var(--shadow-float); z-index: 1001; display: flex; align-items: center; gap: 8px; transform: translateX(150%); transition: transform 0.3s ease; }
        .notification.show { transform: translateX(0); }
        .notification.error { background: var(--color-danger); }
        .notification.warning { background: var(--color-warning); color: var(--text-main); }
        .svg-no-fill { fill: none; }
        #lang-container { display: contents; }
        /* 默认移动端隐藏 */
        .shortcut-hint { display: none; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); z-index: 2; pointer-events: none; color: var(--text-tertiary); font-size: 12px; }
        .shortcut-kbd { font-family: monospace; border: 1px solid var(--border-base); border-radius: 4px; padding: 2px 6px; background: var(--bg-hover); white-space: nowrap; }
        /* 仅在桌面端 (宽度 > 768px) 显示快捷键提示 */
        @media (min-width: 768px) { .shortcut-hint { display: block; } }
        .back-to-top { position: fixed; bottom: 20px; right: 20px; width: 45px; height: 45px; border-radius: 50%; background: var(--color-primary); color: var(--text-inverse); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px var(--shadow-heavy); opacity: 0; visibility: hidden; transition: all 0.3s ease; z-index: 999; }
        .back-to-top.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .back-to-top:active { transform: scale(0.9); }
        @media (hover: hover) { .back-to-top:hover { background: var(--color-primary-dark); transform: translateY(-3px); } }

        /* === Responsive === */
        @media (max-width: 600px) {
            .controls-bar { flex-wrap: wrap; }
            .search-box { width: 100%; flex: none; }
            .dropdown-container { flex: 1; }
            .dropdown-btn { width: 100%; justify-content: space-between; }
            .dropdown-menu-content { width: 100%; }
            .container { border-radius: 8px; }
            .main-content { padding: 15px; }
            .task-header { flex-direction: column; align-items: flex-start; }
            .task-date { margin-top: 5px; }
            .modal-content { width: 95%; }
            .datetime-group { flex-direction: column; gap: 8px; }
            header { padding: 15px 20px; flex-direction: row; align-items: flex-start; }
            .header-actions { display: flex; flex-direction: row; gap: 3px; align-items: flex-end; }
            .icon-btn { font-size: 10px; padding: 6px 10px; }
            .task-actions { flex-direction: row; }
        }

        .app-footer { margin-top: 40px; padding: 20px 10px; text-align: center; font-size: 14px; color: var(--text-tertiary); border-top: 1px solid var(--shadow-base); background: linear-gradient(to top, rgba(0,0,0,0.03), transparent); }
        .footer-link { display: inline-flex; align-items: center; gap: 8px; color: var(--text-secondary); text-decoration: none; font-weight: 500; transition: all 0.25s ease; }
        .footer-link:hover { color: var(--color-primary); }
        .footer-link svg { transition: transform 0.25s ease; fill: currentColor; }
        .footer-link:hover svg { transform: scale(1.15); }
        .footer-copyright { margin-top: 8px; font-size: 12px; color: var(--text-tertiary); }
    </style>
    <script>
        // 解决暗色模式下刷新闪烁白色
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            let currentTheme = 'light';
            if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) { currentTheme = 'dark'; }
            document.documentElement.setAttribute('data-theme', currentTheme); // 立即设置，在页面渲染前生效
        })();
    </script>
</head>
<body>
<div class="container">
    <header>
        <div>
            <h1 data-i18n="appTitle">任务跟踪器</h1>
            <p class="subtitle" data-i18n="appSubtitle">基于截止日期的任务管理</p>
        </div>
        <div class="header-actions">
            <button class="icon-btn" id="themeToggleBtn" aria-label="切换主题" data-i18n-aria-label="themeTooltip" data-i18n-title="themeTooltip" title="切换主题">
                <svg class="moon-icon svg-no-fill" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <svg class="sun-icon svg-no-fill" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 1V3M12 21V23M4.22 4.22L5.64 5.64M18.36 18.36L19.78 19.78M1 12H3M21 12H23M4.22 19.78L5.64 18.36M18.36 5.64L19.78 4.22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
            <button class="icon-btn" id="openModalBtn" aria-label="添加新任务" data-i18n-aria-label="addNewTask" data-i18n-title="addNewTaskTooltip" title="添加新任务 (Ctrl+I)">
                <svg class="svg-no-fill" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M12 5V19M5 12H19" stroke="currentColor" stroke-linecap="round" stroke-width="2"/></svg>
            </button>
            <button class="icon-btn" id="openMenuBtn" aria-label="打开菜单" data-i18n-aria-label="openMenu" aria-haspopup="true" aria-expanded="false" data-i18n-title="menuTooltip" title="菜单 (Ctrl+M)">
                <svg height="18" viewBox="0 0 24 24" width="18" style="fill: currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M4 12C4 11.4477 4.44772 11 5 11H19C19.5523 11 20 11.4477 20 12C20 12.5523 19.5523 13 19 13H5C4.44772 13 4 12.5523 4 12Z"/><path d="M4 6C4 5.44772 4.44772 5 5 5H19C19.5523 5 20 5.44772 20 6C20 6.55228 19.5523 7 19 7H5C4.44772 7 4 6.55228 4 6Z"/><path d="M4 18C4 17.4477 4.44772 17 5 17H19C19.5523 17 20 17.4477 20 18C20 18.5523 19.5523 19 19 19H5C4.44772 19 4 18.5523 4 18Z"/></svg>
            </button>
            <div class="menu" id="menu">
                <button class="menu-item" data-i18n-title="export" id="exportBtn" title="导出">
                    <svg class="svg-no-fill" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 4V16M12 4L8 8M12 4L16 8" stroke="currentColor" stroke-width="2"/><path d="M4 20H20" stroke="currentColor" stroke-width="2"/></svg>
                    <span data-i18n="export">导出</span>
                </button>
                <button class="menu-item" data-i18n-title="import" id="importBtn" title="导入">
                    <svg class="svg-no-fill" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 20V8M12 20L8 16M12 20L16 16" stroke="currentColor" stroke-width="2"/><path d="M4 4H20" stroke="currentColor" stroke-width="2"/></svg>
                    <span data-i18n="import">导入</span>
                </button>
                <div class="menu-divider"></div>
                <button class="menu-item" data-i18n-title="clearCompletedTitle" id="clearCompletedBtn" title="清除所有已完成的任务">
                    <svg class="svg-no-fill" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 16px; height: 16px; color: var(--color-danger); fill: none;"><path d="M5.75 5.75C5.75 4.7835 6.5335 4 7.5 4H16.5C17.4665 4 18.25 4.7835 18.25 5.75V8.25H5.75V5.75Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M4 8.25H20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M17.5 8.25V17.5C17.5 18.8807 16.3807 20 15 20H9C7.61929 20 6.5 18.8807 6.5 17.5V8.25" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M9.5 11.25V16.25" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M14.5 11.25V16.25" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    <span data-i18n="clearCompleted">清除已完成</span>
                </button>
                <div class="menu-divider"></div>
                <button class="menu-item" id="langMenuToggle" aria-haspopup="true" aria-expanded="false">
                    <svg viewBox="0 0 24 24" class="svg-no-fill" xmlns="http://www.w3.org/2000/svg" style="width: 16px; height: 16px; color: var(--color-primary); fill: none;"><path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2Z" stroke="currentColor" stroke-width="2"/><path d="M2 12H22" stroke="currentColor" stroke-width="2"/><path d="M12 2C14.7614 2 17 6.48 17 12C17 17.52 14.7614 22 12 22C9.23858 22 7 17.52 7 12C7 6.48 9.23858 2 12 2Z" stroke="currentColor" stroke-width="2"/></svg>
                    <span data-i18n="language" style="margin-left: 10px;">语言</span>
                    <svg width="16" height="16" viewBox="0 0 24 24" class="svg-no-fill" style="margin-left: auto; transition: transform 0.2s;" xmlns="http://www.w3.org/2000/svg"><path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
                <div class="submenu" id="langSubmenu"><div id="lang-container"></div></div>
            </div>
        </div>
        <input accept=".json" class="file-input" id="importFile" type="file">
    </header>
    <div class="main-content">
        <div class="controls-bar" role="toolbar" aria-label="任务工具栏">
            <div class="search-box">
                <label for="searchInput" class="sr-only" data-i18n="searchPlaceholder">搜索任务...</label>
                <input class="search-input" data-i18n-placeholder="searchPlaceholder" id="searchInput" placeholder="搜索任务..." type="text">
                <div class="shortcut-hint"><kbd class="shortcut-kbd" title="Ctrl + K">⌘K</kbd></div>
            </div>
            <div class="dropdown-container" id="filterDropdown">
                <button class="dropdown-btn" id="filterBtn" aria-haspopup="true" aria-expanded="false">
                    <svg width="16" height="16" viewBox="0 0 24 24" class="svg-no-fill" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.7;"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                    <span id="currentFilterLabel" data-i18n="filterActive">进行中</span>
                    <svg width="16" height="16" viewBox="0 0 24 24" class="svg-no-fill chevron" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>
                </button>
                <div class="dropdown-menu-content">
                    <button class="dropdown-option" data-filter="all"><span data-i18n="filterAll">全部</span></button>
                    <button class="dropdown-option selected" data-filter="active"><span data-i18n="filterActive">进行中</span></button>
                    <button class="dropdown-option" data-filter="completed"><span data-i18n="filterCompleted">已完成</span></button>
                    <button class="dropdown-option" data-filter="overdue"><span data-i18n="filterOverdue">已过期</span></button>
                    <button class="dropdown-option" data-filter="no-deadline"><span data-i18n="filterNoDeadline">无截止日期</span></button>
                </div>
            </div>
            <div class="dropdown-container" id="sortDropdown">
                <button class="dropdown-btn" id="sortBtn" aria-haspopup="true" aria-expanded="false">
                    <svg width="16" height="16" viewBox="0 0 24 24" class="svg-no-fill" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.7;"><path d="M7 15l5 5 5-5"/><path d="M7 9l5-5 5 5"/></svg>
                    <span id="currentSortLabel" data-i18n="sortSmart">智能排序</span>
                    <svg width="16" height="16" viewBox="0 0 24 24" class="svg-no-fill chevron" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>
                </button>
                <div class="dropdown-menu-content">
                    <button class="dropdown-option selected" data-sort="smart"><span data-i18n="sortSmart">智能排序</span></button>
                    <button class="dropdown-option" data-sort="created-desc"><span data-i18n="sortCreated">新创建</span></button>
                    <button class="dropdown-option" data-sort="due-asc"><span data-i18n="sortDue">截止日期</span></button>
                    <button class="dropdown-option" data-sort="alpha-asc"><span data-i18n="sortAlpha">A-Z</span></button>
                </div>
            </div>
        </div>
        <!-- 任务展示区域 -->
        <div class="tasks-section">
            <div id="taskList" aria-live="polite">
                <div class="loading-state" id="initial-loader">
                    <div class="spinner"></div>
                </div>
                <!-- 任务将通过JavaScript动态添加 -->
            </div>
        </div>
    </div>
</div>

<button id="backToTopBtn" class="back-to-top" aria-label="回到顶部" data-i18n-aria-label="backToTopTooltip" data-i18n-title="backToTopTooltip" title="回到顶部 (Alt + T)">
    <svg width="24" height="24" viewBox="0 0 24 24" class="svg-no-fill" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg>
</button>

<div class="modal" id="taskModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" data-i18n="addNewTask" id="modalTitle">添加新任务</h3>
            <button class="close-btn" id="closeModalBtn">&times;</button>
        </div>
        <div class="modal-body">
            <form id="taskForm">
                <div class="form-group">
                    <label data-i18n="taskNameLabel" for="taskName">任务名称 *</label>
                    <input data-i18n-placeholder="taskNamePlaceholder" id="taskName" name="taskName" placeholder="输入任务名称" required type="text">
                </div>
                <div class="form-group">
                    <label data-i18n="taskDescLabel" for="taskDesc">任务描述 (可选)</label>
                    <textarea data-i18n-placeholder="taskDescPlaceholder" id="taskDesc" placeholder="输入任务描述"></textarea>
                </div>
                <div class="form-group">
                    <label data-i18n="dueDateLabel" for="dueDate">截止日期 (可选)</label>
                    <div class="datetime-group">
                        <input class="date-input" id="dueDate" type="date">
                        <label for="dueTime" class="sr-only" data-i18n="dueTimeLabel">截止时间</label>
                        <input class="time-input" id="dueTime" type="time" value="23:59">
                    </div>
                    <div class="checkbox-group">
                        <label data-i18n="noDeadlineLabel" for="noDeadline">无截止日期</label>
                        <input id="noDeadline" type="checkbox">
                    </div>
                </div>
                <div class="form-group">
                    <label data-i18n="subtasksLabel">子任务 (可选)</label>
                    <div class="subtask-input-wrapper">
                        <label for="subtaskInput"></label><input type="text" id="subtaskInput" data-i18n-placeholder="subtaskPlaceholder" placeholder="添加子任务..." autocomplete="off">
                        <button type="button" id="addSubtaskBtn" class="btn-icon-small" title="添加">
                            <svg width="16" height="16" viewBox="0 0 24 24" class="svg-no-fill" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        </button>
                    </div>
                    <ul id="subtaskListPreview" class="subtask-preview-list"></ul>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" data-i18n="cancel" id="cancelBtn" type="button">取消</button>
                    <button class="btn btn-primary" data-i18n="addTask" id="submitBtn" type="submit">添加任务</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="notification" id="notification" role="status" aria-live="polite">
    <svg class="svg-no-fill" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M20 6L9 17L4 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg>
    <span id="notificationText"></span>
</div>

<template id="task-template">
    <div class="task-item">
        <div class="task-header">
            <div class="task-title">
                <svg width="16" height="16" viewBox="0 0 24 24" class="svg-no-fill" xmlns="http://www.w3.org/2000/svg"><path d="M20 6L9 17L4 12" stroke="var(--color-success)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <span class="task-name"></span>
            </div>
            <div class="task-date"></div>
        </div>
        <div class="task-desc"></div>
        <div class="subtasks-list"></div>
        <div class="progress-bar"><div class="progress-fill"></div></div>
        <div class="task-footer">
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span class="status-text"></span> <span class="status-time-left"></span> </div>
            <div class="task-actions">
                <button class="action-btn complete-btn" data-action="toggle" title="标记完成">
                    <svg width="18" height="18" viewBox="0 0 24 24" class="svg-no-fill" xmlns="http://www.w3.org/2000/svg"><path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
                <button class="action-btn edit-btn" data-action="edit" title="编辑">
                    <svg width="18" height="18" viewBox="0 0 24 24" class="svg-no-fill" xmlns="http://www.w3.org/2000/svg"><path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M18.5 2.5C18.8978 2.10217 19.4374 1.87868 20 1.87868C20.5626 1.87868 21.1022 2.10217 21.5 2.5C21.8978 2.89782 22.1213 3.43739 22.1213 4C22.1213 4.56261 21.8978 5.10217 21.5 5.5L12 15L8 16L9 12L18.5 2.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
                <button class="action-btn delete-btn" data-action="delete" title="删除">
                    <svg width="18" height="18" viewBox="0 0 24 24" class="svg-no-fill" xmlns="http://www.w3.org/2000/svg"><path d="M19 7L18.1327 19.1425C18.0579 20.1891 17.187 21 16.1378 21H7.86224C6.81296 21 5.94208 20.1891 5.86732 19.1425L5 7M10 11V17M14 11V17M15 7V4C15 3.44772 14.5523 3 14 3H10C9.44772 3 9 3.44772 9 4V7M4 7H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
            </div>
        </div>
    </div>
</template>

<footer class="app-footer">
    <a href="https://github.com/muquew/Task-Tracer" target="_blank" class="footer-link">
        <svg height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 0C5.37 0 0 5.373 0 12c0 5.303 3.438 9.8 8.205 11.387.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.727-4.042-1.61-4.042-1.61-.546-1.387-1.333-1.757-1.333-1.757 -1.09-.745.083-.729.083-.729 1.205.085 1.84 1.238 1.84 1.238 1.07 1.835 2.807 1.305 3.492.998.108-.775.418-1.305.76-1.606-2.665-.305-5.466-1.334-5.466-5.932 0-1.31.47-2.382 1.236-3.22-.125-.303-.535-1.523.115-3.176 0 0 1.008-.322 3.3 1.23a11.49 11.49 0 013.004-.404 c1.02.005 2.045.138 3.003.404 2.292-1.552 3.3-1.23 3.3-1.23.65 1.653.24 2.873.12 3.176.77.838 1.236 1.91 1.236 3.22 0 4.61-2.804 5.624-5.475 5.922.43.372.81 1.102.81 2.222 0 1.606-.015 2.896-.015 3.286 0 .32.216.694.825.576C20.565 21.796 24 17.3 24 12 24 5.373 18.627 0 12 0z"/>
        </svg>
        GitHub
    </a>
    <div class="footer-copyright">© 2025 muquew · Personal Non-Commercial License</div>
</footer>

<script>
    (function() {
        // ==========================================
        // 1. 配置与状态 (Config & State)
        // ==========================================
        const CONFIG = {
            DB_NAME: 'TaskTrackerDB',
            DB_VERSION: 2,
            STORE_TASKS: 'tasks',
            STORE_CONFIG: 'config',
            LANGUAGES: [
                { code: 'zh-CN', name: '简体中文' },
                { code: 'en', name: 'English' }]
        };

        const state = {
            db: null,
            tasks: [],
            filter: 'active',
            sort: 'smart',
            searchQuery: '',
            editingTaskId: null,
            currentLanguage: 'zh-CN',
            translations: {},
            tempSubtasks: [], // 编辑/新建时暂存的子任务
            progressInterval: null
        };

        // ==========================================
        // 2. DOM 元素引用 (DOM References)
        // ==========================================
        const DOM = {}; // 集中存储 DOM 节点

        function cacheDOM() {
            // 核心容器与按钮
            DOM.taskList = document.getElementById('taskList');
            DOM.taskTemplate = document.getElementById('task-template');
            DOM.themeBtn = document.getElementById('themeToggleBtn');
            DOM.backToTopBtn = document.getElementById('backToTopBtn');
            DOM.clearCompletedBtn = document.getElementById('clearCompletedBtn');

            // 模态框与表单
            DOM.modal = document.getElementById('taskModal');
            DOM.form = document.getElementById('taskForm');
            DOM.openModalBtn = document.getElementById('openModalBtn');
            DOM.closeModalBtn = document.getElementById('closeModalBtn');
            DOM.cancelBtn = document.getElementById('cancelBtn');
            DOM.modalTitle = document.getElementById('modalTitle');
            DOM.submitBtn = document.getElementById('submitBtn');

            // 输入字段
            DOM.inputs = {
                name: document.getElementById('taskName'),
                desc: document.getElementById('taskDesc'),
                date: document.getElementById('dueDate'),
                time: document.getElementById('dueTime'),
                noDeadline: document.getElementById('noDeadline'),
                search: document.getElementById('searchInput'),
                subtask: document.getElementById('subtaskInput')
            };
            DOM.formGroups = document.querySelectorAll('.form-group');

            // 子任务相关
            DOM.addSubtaskBtn = document.getElementById('addSubtaskBtn');
            DOM.subtaskListPreview = document.getElementById('subtaskListPreview');

            // 菜单与下拉
            DOM.menu = {
                container: document.getElementById('menu'),
                btn: document.getElementById('openMenuBtn'),
                langToggle: document.getElementById('langMenuToggle'),
                langSubmenu: document.getElementById('langSubmenu'),
                langContainer: document.getElementById('lang-container'),
                exportBtn: document.getElementById('exportBtn'),
                importBtn: document.getElementById('importBtn'),
                fileInput: document.getElementById('importFile')
            };

            DOM.dropdowns = {
                filter: { container: document.getElementById('filterDropdown'), btn: document.getElementById('filterBtn') },
                sort: { container: document.getElementById('sortDropdown'), btn: document.getElementById('sortBtn') }
            };

            // 通知
            DOM.notification = {
                el: document.getElementById('notification'),
                text: document.getElementById('notificationText')
            };
        }

        // ==========================================
        // 3. 初始化流程 (Initialization)
        // ==========================================
        document.addEventListener('DOMContentLoaded', initApp);

        async function initApp() {
            cacheDOM(); // 1. 获取所有 DOM 元素

            try {
                // 2. 加载基础资源
                await loadTranslations();
                createLangButtons();
                await initDB();

                // 3. 恢复设置
                await loadSettings();
                initLanguage(); // 应用语言并同步 UI

                // 4. 加载数据
                state.tasks = await dbActions.getAllTasks();

                // 5. 初始化 UI 状态
                DOM.inputs.date.min = new Date().toISOString().split('T')[0];  // 设置最小日期为今天
                if (state.tasks.length === 0 && !(await dbActions.getConfig('sampleTasksAdded'))) {
                    addSampleTasks();
                    await dbActions.setConfig('sampleTasksAdded', true);
                }

                // 6. 绑定事件并渲染
                bindEvents();
                renderApp();

                // 7. 启动定时器
                startProgressTimer();

            } catch (error) {
                console.error('Init failed:', error);
                utils.notify(state.translations[state.currentLanguage]['initDBError'] || 'Error initializing', 'error');
            }
        }

        async function loadSettings() {
            const savedLang = await dbActions.getConfig('language');
            if (savedLang) {
                state.currentLanguage = savedLang;
            } else {
                // 自动检测语言
                const sysLang = navigator.languages || [navigator.language];
                const target = CONFIG.LANGUAGES.find(l => l.code === sysLang || l.code === sysLang.split('-')[0]);
                state.currentLanguage = target ? target.code : 'en';
                await dbActions.setConfig('language', state.currentLanguage);
            }
        }

        // ==========================================
        // 4. 事件绑定 (Event Binding)
        // ==========================================
        function bindEvents() {
            // 全局
            DOM.themeBtn.addEventListener('click', utils.toggleTheme);
            window.addEventListener('scroll', () => DOM.backToTopBtn.classList.toggle('show', window.scrollY > 300));
            DOM.backToTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
            document.addEventListener('keydown', handleKeyboardShortcuts);
            document.addEventListener('visibilitychange', handleVisibilityChange);

            // 模态框
            DOM.openModalBtn.addEventListener('click', () => openModal());
            DOM.closeModalBtn.addEventListener('click', closeModal);
            DOM.cancelBtn.addEventListener('click', closeModal);
            DOM.modal.addEventListener('click', (e) => { if (e.target === DOM.modal) closeModal(); });
            DOM.form.addEventListener('submit', handleTaskSave);

            // 表单交互
            DOM.inputs.noDeadline.addEventListener('change', function() {
                DOM.inputs.date.disabled = this.checked;
                DOM.inputs.time.disabled = this.checked;
                if (this.checked) {
                    DOM.inputs.date.value = new Date().toISOString().split('T')[0];
                    DOM.inputs.time.value = '23:59';
                }
            });

            // 搜索与筛选
            DOM.inputs.search.addEventListener('input', utils.debounce(() => {
                state.searchQuery = DOM.inputs.search.value.toLowerCase();
                renderApp();
            }, 300));
            DOM.clearCompletedBtn.addEventListener('click', handleClearCompleted);

            // 下拉菜单
            setupDropdowns();

            // 主菜单
            DOM.menu.btn.addEventListener('click', (e) => { e.stopPropagation(); toggleMenu(DOM.menu.container, DOM.menu.btn); });
            document.addEventListener('click', (e) => {
                if (DOM.menu.container.classList.contains('show') && !DOM.menu.container.contains(e.target) && !DOM.menu.btn.contains(e.target)) {
                    closeMenu();
                }
            });
            // 语言子菜单
            DOM.menu.langToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                const show = DOM.menu.langSubmenu.classList.toggle('show');
                DOM.menu.langToggle.classList.toggle('open');
                DOM.menu.langToggle.setAttribute('aria-expanded', show);
            });
            DOM.menu.langContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('lang-btn')) {
                    switchLanguage(e.target.dataset.lang);
                }
            });

            // 导入导出
            DOM.menu.exportBtn.addEventListener('click', exportTasks);
            DOM.menu.importBtn.addEventListener('click', () => DOM.menu.fileInput.click());
            DOM.menu.fileInput.addEventListener('change', (e) => importTasks(e.target.files[0]));

            // 任务列表交互 (委托)
            DOM.taskList.addEventListener('click', handleTaskListClick);

            // 子任务输入交互
            DOM.addSubtaskBtn.addEventListener('click', handleAddSubtaskInput);
            DOM.inputs.subtask.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); handleAddSubtaskInput(); }
            });
            DOM.subtaskListPreview.addEventListener('click', (e) => {
                const btn = e.target.closest('.subtask-delete-btn');
                if (btn) {
                    state.tempSubtasks.splice(Number(btn.dataset.index), 1);
                    renderSubtaskPreview();
                }
            });
        }

        function handleKeyboardShortcuts(e) {
            const meta = e.ctrlKey || e.metaKey;
            // 1. Ctrl/Cmd + K: 聚焦搜索
            if (meta && e.key === 'k') { e.preventDefault(); DOM.inputs.search.focus(); }
            // 2. Ctrl/Cmd + I: 新建任务
            if (meta && e.key === 'i') { e.preventDefault(); if (DOM.modal.style.display !== 'flex') openModal(); }
            // 3. Ctrl/Cmd + M: 切换菜单
            if (meta && e.key === 'm') { e.preventDefault(); toggleMenu(DOM.menu.container, DOM.menu.btn); }
            // 4. Alt + T: 平滑回到顶部
            if (e.altKey && e.key.toLowerCase() === 't') { e.preventDefault(); window.scrollTo({ top: 0, behavior: 'smooth' }); }
            // 5. Esc: 关闭操作
            if (e.key === 'Escape') {
                if (DOM.modal.style.display === 'flex') closeModal();
                else if (document.activeElement === DOM.inputs.search) DOM.inputs.search.blur();
                else closeMenu();
            }
        }

        // ==========================================
        // 5. 业务逻辑 (Business Logic)
        // ==========================================

        // --- 任务 CRUD ---
        async function handleTaskSave(e) {
            e.preventDefault();
            const t = state.translations[state.currentLanguage];

            const dueDateTime = (!DOM.inputs.noDeadline.checked && DOM.inputs.date.value)
                ? utils.localToUTC(DOM.inputs.date.value, DOM.inputs.time.value) : null;

            const taskPayload = {
                name: DOM.inputs.name.value.trim(),
                description: DOM.inputs.desc.value.trim(),
                subtasks: state.tempSubtasks,
                dueDate: dueDateTime,
                completed: false
            };

            try {
                if (state.editingTaskId) {
                    const original = state.tasks.find(t => t.id === state.editingTaskId);
                    await dbActions.updateTask({ ...original, ...taskPayload });
                    utils.notify(t['taskUpdated']);
                } else {
                    await dbActions.addTask({
                        id: Date.now(),
                        createdAt: new Date().toISOString(),
                        ...taskPayload
                    });
                    utils.notify(t['taskAdded']);
                }
                state.tasks = await dbActions.getAllTasks();
                renderApp();
                closeModal();
            } catch (err) { utils.notify(t['saveError'], 'error'); }
        }

        function editTask(id) {
            const task = state.tasks.find(t => t.id === id);
            if (!task) return;
            openModal(task);
        }

        async function deleteTask(id) {
            const t = state.translations[state.currentLanguage];
            utils.confirm(t['deleteTaskTitle'], t['confirmDelete'], async () => {
                try {
                    await dbActions.deleteTask(id);
                    state.tasks = state.tasks.filter(task => task.id !== id);
                    renderApp();
                    utils.notify(t['taskDeleted']);
                } catch (e) { utils.notify(t['deleteError'], 'error'); }
            });
        }

        async function toggleTaskComplete(id) {
            const task = state.tasks.find(t => t.id === id);
            if (!task) return;
            task.completed = !task.completed;
            await dbActions.updateTask(task);

            // 动画反馈
            const el = document.querySelector(`.task-item[data-task-id="${id}"]`);
            if (el && task.completed) {
                el.classList.add('animate-complete');
                setTimeout(() => el.classList.remove('animate-complete'), 500);
            }

            const t = state.translations[state.currentLanguage];
            utils.notify(task.completed ? t['taskMarkedComplete'] : t['taskMarkedIncomplete']);
            renderApp();
        }

        async function handleClearCompleted() {
            const t = state.translations[state.currentLanguage];
            const completed = state.tasks.filter(x => x.completed);
            if (completed.length === 0) return utils.notify(t['noCompletedTasks'], 'warning');

            utils.confirm(t['clearCompleted'], t['confirmClearCompleted'].replace('{count}', completed.length), async () => {
                await Promise.all(completed.map(task => dbActions.deleteTask(task.id)));
                state.tasks = state.tasks.filter(x => !x.completed);
                renderApp();
                utils.notify(t['completedTasksCleared'].replace('{count}', completed.length));
            });
        }

        // --- 子任务逻辑 ---
        function handleAddSubtaskInput() {
            const val = DOM.inputs.subtask.value.trim();
            if (!val) return;
            state.tempSubtasks.push({ id: Date.now(), text: val, completed: false });
            DOM.inputs.subtask.value = '';
            renderSubtaskPreview();
            DOM.inputs.subtask.focus();
        }

        async function toggleSubtaskComplete(taskId, subtaskId) {
            const task = state.tasks.find(t => t.id === taskId);
            if (!task || !task.subtasks) return;

            const sub = task.subtasks.find(s => s.id === subtaskId);
            if (sub) {
                // 1. 更新数据
                sub.completed = !sub.completed;
                await dbActions.updateTask(task);

                // 2. DOM 局部更新
                const taskEl = document.querySelector(`.task-item[data-task-id="${taskId}"]`);
                if (!taskEl) return;  // 如果找不到元素，直接退出防止报错

                // 更新 Checkbox 状态
                const checkbox = taskEl.querySelector(`.subtask-checkbox[data-subtask-id="${subtaskId}"]`);
                if (checkbox) {
                    checkbox.checked = sub.completed;
                    const row = checkbox.closest('.subtask-display-item');
                    if (row) row.classList.toggle('completed', sub.completed);
                }

                // 更新顶部计数 1/3
                const total = task.subtasks.length;
                const completedCount = task.subtasks.filter(s => s.completed).length;
                const progressText = taskEl.querySelector('.subtask-summary-bar .progress-text');
                if (progressText) progressText.textContent = `${completedCount}/${total} Subtasks`;

                updateTaskNodesTime(); // 更新主卡片状态颜色
            }
        }

        // ==========================================
        // 6. UI 渲染 (Rendering)
        // ==========================================

        function renderApp() {
            const t = state.translations[state.currentLanguage];
            if (!t) return;

            // 1. 筛选与排序
            let result = state.tasks.filter(task => {
                if (state.searchQuery && !task.name.toLowerCase().includes(state.searchQuery) &&
                    !(task.description && task.description.toLowerCase().includes(state.searchQuery))) return false;

                switch (state.filter) {
                    case 'active': return !task.completed;
                    case 'completed': return task.completed;
                    case 'overdue': return !task.completed && task.dueDate && new Date(task.dueDate) < new Date();
                    case 'no-deadline': return !task.dueDate;
                    default: return true;
                }
            });

            result = utils.sortTasks(result);

            // 2. 空状态处理
            const loader = document.getElementById('initial-loader');
            if (loader) loader.remove();

            if (result.length === 0) {
                DOM.taskList.innerHTML = getEmptyStateHTML(t);
                return;
            }
            // 清除空状态
            if (DOM.taskList.querySelector('.empty-state')) DOM.taskList.innerHTML = '';

            // 3. DOM Diff/Patch (简单版)
            const existingMap = new Map();
            Array.from(DOM.taskList.children).forEach(el => {
                if (el.classList.contains('task-item')) existingMap.set(Number(el.dataset.taskId), el);
            });

            let refNode = DOM.taskList.firstChild;
            result.forEach(task => {
                const existingEl = existingMap.get(task.id);
                if (existingEl) {
                    updateTaskNode(existingEl, task);
                    if (existingEl !== refNode) DOM.taskList.insertBefore(existingEl, refNode);
                    existingMap.delete(task.id);
                    refNode = existingEl.nextSibling;
                } else {
                    const newEl = createTaskNode(task);
                    DOM.taskList.insertBefore(newEl, refNode);
                }
            });

            // 移除多余元素
            existingMap.forEach(el => el.remove());
        }

        function createTaskNode(task) {
            const el = DOM.taskTemplate.content.cloneNode(true).firstElementChild;
            el.dataset.taskId = task.id;
            updateTaskNode(el, task);
            return el;
        }

        function updateTaskNode(el, task) {
            const t = state.translations[state.currentLanguage];

            // A. 状态计算
            let statusObj;
            let timeLeft = null;
            if (task.completed) statusObj = { cls: 'status-completed', text: t['statusCompleted'], percent: 100 };
            else if (task.dueDate) {
                timeLeft = utils.calculateTimeLeft(task.dueDate);
                statusObj = utils.getStatus(timeLeft);
            } else {
                statusObj = { cls: 'status-no-deadline', text: t['statusNoDeadline'], percent: 0 };
            }

            // B. 基础信息
            el.className = `task-item ${statusObj.cls} ${task.completed ? 'completed-task' : ''}`;
            el.querySelector('.task-name').textContent = task.name;
            el.querySelector('.task-date').textContent = task.dueDate ?
                `${t['deadline']}: ${utils.formatDate(task.dueDate)}` : t['noDeadlineText'];

            // C. 描述
            let descEl = el.querySelector('.task-desc');
            if (task.description) {
                if (!descEl) { // 如果模板中没有，（理论上不该发生）
                    descEl = document.createElement('div');
                    descEl.className = 'task-desc';
                    el.querySelector('.task-header').after(descEl);
                }
                descEl.textContent = task.description;
            } else if (descEl) descEl.remove(); // 移除空描述

            // D. 子任务 (Subtasks)
            renderSubtasksInCard(el, task);

            // E. 进度条
            let bar = el.querySelector('.progress-bar');
            if (task.dueDate && !task.completed) {
                if (!bar) {
                    bar = document.createElement('div');
                    bar.className = 'progress-bar';
                    bar.innerHTML = '<div class="progress-fill"></div>';
                    // 插入位置：在子任务之后，或描述之后，或头部之后
                    const prev = el.querySelector('.subtasks-wrapper') || el.querySelector('.task-desc') || el.querySelector('.task-header');
                    prev.after(bar);
                }
                bar.querySelector('.progress-fill').style.width = `${statusObj.percent}%`;
            } else if (bar) bar.remove();

            // F. 底部状态文字
            const statusInd = el.querySelector('.status-indicator');
            statusInd.querySelector('.status-text').textContent = statusObj.text;

            let timeEl = statusInd.querySelector('.status-time-left');
            if (task.dueDate && !task.completed) {
                if (!timeEl) {
                    timeEl = document.createElement('span');
                    timeEl.className = 'status-time-left';
                    statusInd.querySelector('.status-text').after(timeEl);
                }
                timeEl.textContent = `(${utils.formatTime(timeLeft)})`;
            } else if (timeEl) timeEl.remove();

            // G. 按钮 Titles
            el.querySelector('[data-action="toggle"]').title = task.completed ? t['markIncomplete'] : t['markComplete'];
            el.querySelector('[data-action="edit"]').title = t['editTaskTitle'];
            el.querySelector('[data-action="delete"]').title = t['deleteTaskTitle'];
        }

        function renderSubtasksInCard(el, task) {
            let wrapper = el.querySelector('.subtasks-wrapper');

            // 如果没有子任务，移除容器并退出
            if (!task.subtasks || task.subtasks.length === 0) {
                if (wrapper) wrapper.remove();
                return;
            }

            // 创建容器
            if (!wrapper) {
                wrapper = document.createElement('div');
                wrapper.className = 'subtasks-wrapper';
                const prev = el.querySelector('.task-desc') || el.querySelector('.task-header');
                prev.after(wrapper);
            }

            const total = task.subtasks.length;
            const completed = task.subtasks.filter(s => s.completed).length;

            // 每次都重绘内部 HTML，因为状态可能变了
            // 注意：我们使用 innerHTML 重绘，这会导致折叠状态丢失，所以需要先保存状态
            const wasExpanded = wrapper.classList.contains('expanded');

            wrapper.innerHTML = `
                <div class="subtask-summary-bar">
                    <div class="subtask-count-text">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                        <span class="progress-text">${completed}/${total} Subtasks</span>
                    </div>
                    <svg class="subtask-toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </div>
                <div class="subtasks-list">
                    ${task.subtasks.map(sub => `
                        <div class="subtask-display-item ${sub.completed ? 'completed' : ''}">
                            <input type="checkbox" class="subtask-checkbox" data-subtask-id="${sub.id}" ${sub.completed ? 'checked' : ''}>
                            <span class="subtask-text">${sub.text}</span>
                        </div>
                    `).join('')}
                </div>
            `;

            // 恢复折叠状态
            if (wasExpanded) wrapper.classList.add('expanded');
        }

        function renderSubtaskPreview() {
            DOM.subtaskListPreview.innerHTML = state.tempSubtasks.map((sub, idx) => `
                <li class="subtask-preview-item">
                    <span>${sub.text}</span>
                    <button type="button" class="subtask-delete-btn" data-index="${idx}" title="删除">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </li>
            `).join('');
        }

        function openModal(editingTask = null) {
            // 重置状态
            DOM.form.reset();
            DOM.formGroups.forEach(g => g.style.display = 'block');
            const msg = document.getElementById('confirm-message-text');
            if(msg) msg.style.display = 'none';
            DOM.submitBtn.type = 'submit';
            // 清除可能残留的一次性事件
            if (DOM.submitBtn._confirmHandler) {
                DOM.submitBtn.removeEventListener('click', DOM.submitBtn._confirmHandler);
                delete DOM.submitBtn._confirmHandler;
            }

            const t = state.translations[state.currentLanguage];

            if (editingTask) {
                state.editingTaskId = editingTask.id;
                DOM.modalTitle.textContent = t['editTask'];
                DOM.submitBtn.textContent = t['updateTask'];
                DOM.inputs.name.value = editingTask.name;
                DOM.inputs.desc.value = editingTask.description || '';

                // 子任务深拷贝
                state.tempSubtasks = editingTask.subtasks ? JSON.parse(JSON.stringify(editingTask.subtasks)) : [];

                if (editingTask.dueDate) {
                    const local = utils.utcToLocal(editingTask.dueDate);
                    DOM.inputs.date.value = local.toISOString().split('T')[0];
                    DOM.inputs.time.value = `${local.getHours().toString().padStart(2,'0')}:${local.getMinutes().toString().padStart(2,'0')}`;
                    DOM.inputs.noDeadline.checked = false;
                    DOM.inputs.date.disabled = false;
                    DOM.inputs.time.disabled = false;
                } else {
                    DOM.inputs.noDeadline.checked = true;
                    DOM.inputs.date.disabled = true;
                    DOM.inputs.time.disabled = true;
                    DOM.inputs.date.value = new Date().toISOString().split('T')[0];
                    DOM.inputs.time.value = '23:59';
                }
            } else {
                state.editingTaskId = null;
                DOM.modalTitle.textContent = t['addNewTask'];
                DOM.submitBtn.textContent = t['addTask'];

                state.tempSubtasks = [];
                DOM.inputs.noDeadline.checked = false;
                DOM.inputs.date.disabled = false;
                DOM.inputs.time.disabled = false;
                DOM.inputs.date.value = new Date().toISOString().split('T')[0];
                DOM.inputs.time.value = '23:59';
            }

            renderSubtaskPreview();
            utils.applyTranslations(); // 刷新弹窗内的多语言
            DOM.modal.style.display = 'flex';
            DOM.inputs.name.focus();
        }

        function closeModal() {
            DOM.modal.style.display = 'none';
            state.editingTaskId = null;
        }

        // ==========================================
        // 7. 数据库层 (IndexedDB Layer)
        // ==========================================
        const dbActions = {
            init: () => new Promise((resolve, reject) => {
                const req = indexedDB.open(CONFIG.DB_NAME, CONFIG.DB_VERSION);
                req.onerror = () => reject(req.error);
                req.onsuccess = () => { state.db = req.result; resolve(); };
                req.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(CONFIG.STORE_TASKS)) { // 创建任务存储
                        const store = db.createObjectStore(CONFIG.STORE_TASKS, { keyPath: 'id' });
                        store.createIndex('dueDate', 'dueDate', { unique: false });
                    }
                    if (!db.objectStoreNames.contains(CONFIG.STORE_CONFIG)) { // 创建配置存储
                        db.createObjectStore(CONFIG.STORE_CONFIG, { keyPath: 'key' });
                    }
                };
            }),
            getAllTasks: () => utils.dbOp(CONFIG.STORE_TASKS, 'readonly', s => s.getAll()),
            addTask: (task) => utils.dbOp(CONFIG.STORE_TASKS, 'readwrite', s => s.add(task)),
            updateTask: (task) => utils.dbOp(CONFIG.STORE_TASKS, 'readwrite', s => s.put(task)),
            deleteTask: (id) => utils.dbOp(CONFIG.STORE_TASKS, 'readwrite', s => s.delete(id)),
            getConfig: (key) => utils.dbOp(CONFIG.STORE_CONFIG, 'readonly', s => s.get(key)).then(res => res ? res.value : null),
            setConfig: (key, value) => utils.dbOp(CONFIG.STORE_CONFIG, 'readwrite', s => s.put({ key, value }))
        };
        // 别名，为了向后兼容 initApp 调用
        const initDB = dbActions.init;

        // ==========================================
        // 8. 工具与辅助函数 (Utilities)
        // ==========================================
        const utils = {
            dbOp: (storeName, mode, callback) => new Promise((resolve, reject) => {
                const tx = state.db.transaction([storeName], mode);
                const req = callback(tx.objectStore(storeName));
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            }),
            debounce: (func, delay) => {
                let id;
                return (...args) => { clearTimeout(id); id = setTimeout(() => func(...args), delay); };
            },
            notify: (msg, type = 'success') => {
                DOM.notification.text.textContent = msg;
                DOM.notification.el.className = `notification ${type} show`;
                DOM.notification.el.setAttribute('role', type === 'error' ? 'alert' : 'status');
                setTimeout(() => DOM.notification.el.classList.remove('show'), 3000);
            },
            confirm: (title, msg, onConfirm) => {
                DOM.modalTitle.textContent = title;

                // 动态创建提示文本
                let p = document.getElementById('confirm-message-text');
                if (!p) {
                    p = document.createElement('p');
                    p.id = 'confirm-message-text';
                    p.style.cssText = 'font-size:16px; line-height:1.5; margin-bottom:20px;';
                    DOM.form.prepend(p);
                }
                p.textContent = msg;
                p.style.display = 'block';

                // 隐藏输入框
                DOM.formGroups.forEach(g => g.style.display = 'none');

                // 修改按钮
                const t = state.translations[state.currentLanguage];
                DOM.submitBtn.textContent = t['confirm'] || 'Confirm';
                DOM.submitBtn.type = 'button';

                const handler = () => { onConfirm(); closeModal(); };
                DOM.submitBtn._confirmHandler = handler;
                DOM.submitBtn.addEventListener('click', handler);

                DOM.modal.style.display = 'flex';
                DOM.submitBtn.focus();
            },
            toggleTheme: () => {
                const html = document.documentElement;
                const newTheme = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
                html.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
            },

            // 时间计算
            localToUTC: (d, t) => new Date(`${d}T${t}`).toISOString(),
            utcToLocal: (iso) => {
                const d = new Date(iso);
                return new Date(d.getTime() - d.getTimezoneOffset() * 60000);
            },
            calculateTimeLeft: (iso) => (utils.utcToLocal(iso) - new Date()) / 60000,

            formatDate: (iso) => {
                const d = utils.utcToLocal(iso);
                return new Intl.DateTimeFormat(state.currentLanguage, {
                    year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                }).format(d);
            },

            formatTime: (min) => {
                const t = state.translations[state.currentLanguage];
                if (min < 0) {
                    const m = Math.abs(Math.floor(min));
                    if (m < 60) return t['minutesAgo'].replace('{minutes}', m);
                    if (m < 1440) return t['hoursAgo'].replace('{hours}', Math.floor(m/60));
                    return t['daysAgo'].replace('{days}', Math.floor(m/1440));
                }
                const m = Math.floor(min);
                if (m < 60) return t['minutesLeft'].replace('{minutes}', m);
                if (m < 1440) {
                    const h = Math.floor(m/60), rest = m%60;
                    return rest>0 ? `${t['hoursLeft'].replace('{hours}',h)} ${t['minutesLeft'].replace('{minutes}',rest)}` : t['hoursLeft'].replace('{hours}',h);
                }
                const d = Math.floor(m/1440), h = Math.floor((m%1440)/60);
                return `${t['daysLeft'].replace('{days}', d)} ${h>0 ? t['hoursLeft'].replace('{hours}', h) : ''}`;
            },

            // 根据剩余时间获取状态
            getStatus: (min) => {
                const t = state.translations[state.currentLanguage];
                // 关键分钟数：3天=4320, 7天=10080, 37天=53280
                // --- 状态: 已过期 (Overdue) ---
                if (min < 0) return { cls: 'status-danger', text: t['statusOverdue'], percent: 100 };
                // --- 状态: 危险 (Danger) --- (窗口: 0 - 3天 / 4320分钟)
                if (min <= 4320) return { cls: 'status-danger', text: t['statusDanger'], percent: Math.min(100, ((4320 - min)/4320)*100) };
                // --- 状态: 警告 (Warning) --- (窗口: 3 - 7天 / 5760分钟)
                if (min <= 10080) return { cls: 'status-warning', text: t['statusWarning'], percent: Math.min(100, ((10080 - min)/5760)*100) };
                // --- 状态: 安全 (Safe) --- (窗口: 7 - 37天 / 43200分钟)
                return { cls: 'status-safe', text: t['statusSafe'], percent: Math.min(100, Math.max(0, ((53280 - min)/43200)*100)) };
            },

            sortTasks: (list) => {
                const l = [...list]; // 复制一份数组以免修改原引用
                switch (state.sort) {
                    case 'created-desc': return l.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    case 'due-asc': return l.sort((a, b) => {
                        if (!a.dueDate && b.dueDate) return 1;
                        if (a.dueDate && !b.dueDate) return -1;
                        if (!a.dueDate && !b.dueDate) return 0;
                        return new Date(a.dueDate) - new Date(b.dueDate);
                    });
                    case 'alpha-asc': return l.sort((a, b) => a.name.localeCompare(b.name, state.currentLanguage));
                    case 'smart': default: return l.sort((a, b) => {
                        // 1. 已完成的放最后
                        if (a.completed !== b.completed) return a.completed ? 1 : -1;
                        // 2. 无截止日期放有截止日期后面
                        if (!a.dueDate && b.dueDate) return 1;
                        if (a.dueDate && !b.dueDate) return -1;
                        // 3. 按截止日期排序
                        if (a.dueDate && b.dueDate) return new Date(a.dueDate) - new Date(b.dueDate);
                        // 4. 最后按创建时间
                        return new Date(a.createdAt) - new Date(b.createdAt);
                    });
                }
            },

            applyTranslations: () => {
                let t = state.translations[state.currentLanguage];
                if (!t) {
                    console.warn(`No translations found for language: ${currentLanguage}. Using default.`);
                    // 尝试使用第一个可用的翻译
                    const fallbackLang = Object.keys(state.translations)[0];
                    if (!fallbackLang) {
                        console.error("No translations available at all.");
                        return; // 无法渲染
                    }
                    state.currentLanguage = fallbackLang;
                    t = state.translations[state.currentLanguage];
                }
                document.querySelectorAll('[data-i18n], [data-i18n-placeholder], [data-i18n-title], [data-i18n-aria-label]').forEach(el => {
                    if (el.dataset.i18n) el.textContent = t[el.dataset.i18n];
                    if (el.dataset.i18nPlaceholder) el.placeholder = t[el.dataset.i18nPlaceholder];
                    if (el.dataset.i18nTitle) el.title = t[el.dataset.i18nTitle];
                    if (el.dataset.i18nAriaLabel) el.setAttribute('aria-label', t[el.dataset.i18nAriaLabel]);
                });
                renderApp();
            }
        };

        // ==========================================
        // 9. 杂项逻辑 (Dropdowns, Menu, etc.)
        // ==========================================

        function setupDropdowns() {
            // 辅助：切换显示
            const toggle = (c, b) => {
                const opening = !c.classList.contains('show');
                // 关闭其他
                Object.values(DOM.dropdowns).forEach(d => {
                    d.container.classList.remove('show');
                    d.btn.setAttribute('aria-expanded', 'false');
                });
                if (opening) {
                    c.classList.add('show');
                    b.setAttribute('aria-expanded', 'true');
                }
            };

            // 绑定点击
            DOM.dropdowns.filter.btn.addEventListener('click', (e) => { e.stopPropagation(); toggle(DOM.dropdowns.filter.container, DOM.dropdowns.filter.btn); });
            DOM.dropdowns.sort.btn.addEventListener('click', (e) => { e.stopPropagation(); toggle(DOM.dropdowns.sort.container, DOM.dropdowns.sort.btn); });

            // 选项点击
            DOM.dropdowns.filter.container.addEventListener('click', (e) => {
                const opt = e.target.closest('.dropdown-option');
                if (opt) {
                    state.filter = opt.dataset.filter;
                    renderApp();
                    syncDropdowns();
                }
            });

            DOM.dropdowns.sort.container.addEventListener('click', (e) => {
                const opt = e.target.closest('.dropdown-option');
                if (opt) {
                    state.sort = opt.dataset.sort;
                    renderApp();
                    syncDropdowns();
                }
            });

            // 点击外部关闭
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.dropdown-container')) {
                    Object.values(DOM.dropdowns).forEach(d => {
                        d.container.classList.remove('show');
                        d.btn.setAttribute('aria-expanded', 'false');
                    });
                }
            });
        }

        function syncDropdowns() {
            // 同步筛选按钮 UI
            const filterOpt = DOM.dropdowns.filter.container.querySelector(`.dropdown-option[data-filter="${state.filter}"]`);
            if (filterOpt) updateDropdownUI(DOM.dropdowns.filter.container, filterOpt, DOM.dropdowns.filter.btn);

            // 同步排序按钮 UI
            const sortOpt = DOM.dropdowns.sort.container.querySelector(`.dropdown-option[data-sort="${state.sort}"]`);
            if (sortOpt) updateDropdownUI(DOM.dropdowns.sort.container, sortOpt, DOM.dropdowns.sort.btn);
        }

        function updateDropdownUI(container, selected, btn) {
            container.querySelectorAll('.dropdown-option').forEach(o => o.classList.remove('selected'));
            selected.classList.add('selected');
            // 关闭菜单
            container.classList.remove('show');
            btn.setAttribute('aria-expanded', 'false');
            // 更新文字
            const span = selected.querySelector('span');
            if (span) {
                const targetSpan = btn.querySelector('[id^="current"]'); // 查找 currentFilterLabel 或 currentSortLabel
                if (targetSpan) targetSpan.textContent = span.textContent;
            }
        }

        function toggleMenu(menu, btn) {
            const opening = !menu.classList.contains('show');
            if (opening) {
                menu.classList.add('show');
                btn.setAttribute('aria-expanded', 'true');
            } else closeMenu();
        }

        function closeMenu() {
            DOM.menu.container.classList.remove('show');
            DOM.menu.btn.setAttribute('aria-expanded', 'false');
            DOM.menu.langSubmenu.classList.remove('show');
            DOM.menu.langToggle.classList.remove('open');
        }

        function handleTaskListClick(e) {
            // 1. 勾选子任务
            if (e.target.classList.contains('subtask-checkbox')) {
                e.stopPropagation();
                const taskId = Number(e.target.closest('.task-item').dataset.taskId);
                const subtaskId = Number(e.target.dataset.subtaskId);
                toggleSubtaskComplete(taskId, subtaskId);
                return;
            }

            // 2. 折叠子任务
            const summary = e.target.closest('.subtask-summary-bar');
            if (summary) {
                summary.closest('.subtasks-wrapper').classList.toggle('expanded');
                return;
            }

            // 3. 主任务动作按钮
            const btn = e.target.closest('.action-btn');
            if (btn) {
                const taskId = Number(btn.closest('.task-item').dataset.taskId);
                const action = btn.dataset.action;
                if (action === 'toggle') toggleTaskComplete(taskId);
                if (action === 'edit') editTask(taskId);
                if (action === 'delete') deleteTask(taskId);
            }
        }

        // --- 其他辅助逻辑 ---
        async function loadTranslations() {
            const promises = CONFIG.LANGUAGES.map(l =>
                fetch(`./resources/${l.code}.json?v=1.2`).then(r => r.json()).then(d => state.translations[l.code] = d)
            );
            await Promise.all(promises);
            if (Object.keys(state.translations).length === 0) utils.notify('加载语言失败，请刷新页面重试', 'error');
        }

        function createLangButtons() {
            DOM.menu.langContainer.innerHTML = '';
            CONFIG.LANGUAGES.forEach(l => {
                const b = document.createElement('button');
                b.className = 'lang-btn';
                b.dataset.lang = l.code;
                b.textContent = l.name;
                DOM.menu.langContainer.appendChild(b);
            });
        }

        function initLanguage() {
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.toggle('active', b.dataset.lang === state.currentLanguage));
            document.documentElement.lang = state.currentLanguage;
            utils.applyTranslations();
            syncDropdowns();
        }

        function switchLanguage(code) {
            if (!state.translations[code]) return;
            state.currentLanguage = code;
            dbActions.setConfig('language', code);
            initLanguage();
        }

        function startProgressTimer() {
            if (state.progressInterval) clearInterval(state.progressInterval);
            state.progressInterval = setInterval(updateTaskNodesTime, 60000);
        }

        function updateTaskNodesTime() {
            if (!state.translations[state.currentLanguage]) return;
            // 仅更新 DOM 中可见的任务
            document.querySelectorAll('.task-item:not(.completed-task)').forEach(el => {
                const id = Number(el.dataset.taskId);
                const task = state.tasks.find(t => t.id === id);
                if (task) updateTaskNode(el, task);
            });
        }

        function getEmptyStateHTML(t) {
            return `<div class="empty-state"><svg width="80" height="80" viewBox="0 0 24 24" class="svg-no-fill"><path d="M9 5H7C5.89543 5 5 5.89543 5 7V19C5 20.1046 5.89543 21 7 21H17C18.1046 21 19 20.1046 19 19V7C19 5.89543 18.1046 5 17 5H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 12H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 16H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 5C9 3.89543 9.89543 3 11 3H13C14.1046 3 15 3.89543 15 5V7H9V5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 12H9.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 16H9.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><h3>${t['noTasks']}</h3><p>${t['noTasksDescription']}</p></div>`;
        }

        function handleVisibilityChange() {
            if (document.hidden && state.progressInterval) clearInterval(state.progressInterval);
            else { updateTaskNodesTime(); startProgressTimer(); }
        }

        function exportTasks() {
            const blob = new Blob([JSON.stringify({ version: '1.0', date: new Date().toISOString(), tasks: state.tasks }, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `tasks_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            utils.notify(state.translations[state.currentLanguage]['exportSuccess']);
        }

        function importTasks(file) {
            if(!file) return;
            const reader = new FileReader();
            const t = state.translations[state.currentLanguage];
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result.toString());
                    if(!Array.isArray(data.tasks)) throw new Error();
                    utils.confirm(t['import'], t['importConfirm'].replace('{count}', data.tasks.length), async () => {
                        const tx = state.db.transaction([CONFIG.STORE_TASKS], 'readwrite');
                        tx.objectStore(CONFIG.STORE_TASKS).clear();
                        for(const task of data.tasks) await dbActions.addTask(task);
                        state.tasks = await dbActions.getAllTasks();
                        renderApp();
                        utils.notify(t['importSuccess'].replace('{count}', data.tasks.length));
                    });
                } catch(err) { utils.notify(t['importReadError'], 'error'); }
            };
            reader.readAsText(file);
            DOM.menu.fileInput.value = '';
        }

        function addSampleTasks() {
            const t = state.translations[state.currentLanguage];
            const samples = [
                { id: Date.now()+1, name: t['sampleTask1Name'] || "完成项目报告", description: t['sampleTask1Desc'] || "编写并提交季度项目总结报告", dueDate: new Date(Date.now() + 432000000).toISOString(), createdAt: new Date().toISOString(), completed: false },
                { id: Date.now()+2, name: t['sampleTask2Name'] || "团队会议准备", description: t['sampleTask2Desc'] || "准备下周团队会议的演示材料", dueDate: new Date(Date.now() + 864000000).toISOString(), createdAt: new Date().toISOString(), completed: false },
                { id: Date.now()+3, name: t['sampleTask3Name'] || "学习计划制定", description: t['sampleTask3Desc'] || "制定下个月的个人学习计划", dueDate: null, createdAt: new Date().toISOString(), completed: false }
            ];
            samples.forEach(s => dbActions.addTask(s));
        }

    })();
</script>
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').then((reg) => console.log('SW registered:', reg.scope)).catch((err) => console.log('SW failed:', err));
        });
    }
</script>
</body>
</html>